# .github/workflows/ci.yml

name: CI Pipeline

# 1. GATILHOS (Triggers)
# Roda este workflow em qualquer push para a 'main' ou 'develop', 
# ou em qualquer Pull Request.
on:
  push:
    branches: [ "main", "develop" ]
  pull_request:

# 2. JOBS (Trabalhos)
# Definimos 'jobs' e usamos 'needs' para criar dependências.
jobs:
  
  # ---------- GRUPO DE LINT (Roda primeiro) ----------
  lint-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          cd backend
          pip install --cache-dir ../.pip-cache -r requirements.txt
      - name: Run lint
        run: cd backend && flake8 .
  
  lint-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install dependencies
        run: cd frontend && npm ci
      - name: Run lint
        run: cd frontend && npm run lint

  # ---------- GRUPO DE BUILD (Depende do lint) ----------
  build-backend:
    runs-on: ubuntu-latest
    needs: [lint-backend] # Depende do job de lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: cd backend && pip install --cache-dir ../.pip-cache -r requirements.txt
      - name: Run check
        run: cd backend && python manage.py check

  build-frontend:
    runs-on: ubuntu-latest
    needs: [lint-frontend] # Depende do job de lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install dependencies
        run: cd frontend && npm ci
      - name: Run build
        run: cd frontend && npm run build

  # ---------- GRUPO DE TESTE (Depende do build) ----------
  test-backend:
    runs-on: ubuntu-latest
    needs: [build-backend] # Depende do job de build
    
    # Anexa um container de Postgres ao job
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432 # Mapeia a porta para o 'localhost' do runner

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: cd backend && pip install --cache-dir ../.pip-cache -r requirements.txt
      - name: Run tests
        # Passa as variáveis de ambiente para o Django
        env:
          DB_NAME: test_db
          DB_USER: test_user
          DB_PASSWORD: test_password
          DB_HOST: 127.0.0.1 # No GitHub Actions, o serviço é mapeado para o localhost
          DB_PORT: 5432
        run: cd backend && python manage.py test

  test-frontend:
    runs-on: ubuntu-latest
    needs: [build-frontend] # Depende do job de build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install dependencies
        run: cd frontend && npm ci
      - name: Run tests
        run: cd frontend && npm run test